<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>Stuttgart Christmas Game</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="main.css" />
</head>
<body class="game-body">
    
    <canvas id="snowCanvas"></canvas>
    <canvas id="iceFallCanvas" class="hidden"></canvas>
    <div id="iceOverlay" class="ice-overlay hidden"></div>
    <div id="fireOverlay" class="fire-overlay hidden"></div>
    <div id="cocoaOverlay" class="cocoa-overlay hidden"></div>
    
    <audio id="lavaAudio" src="minecraft-drinking-sound-effect.mp3" preload="auto"></audio>

    <div id="lastChanceTimer" class="hidden">
        <span>‚ö†Ô∏è –ü–û–°–õ–ï–î–ù–ò–ô –®–ê–ù–°: </span>
        <span id="timerCountdown">05:00</span>
    </div>

    <div class="game-wrap">
        
        <header class="game-header">
            <div class="header-left">
                <div class="avatar-circle" id="myTeamAvatar"></div>
                <div>
                    <span id="myNameHeader" class="player-name-header">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    <div class="player-info-role">
                        <strong id="myTeamName">...</strong> ‚Ä¢ <span id="myPlayerRole">...</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="icon-btn" onclick="window.openItemsGuide()" title="–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫">üìñ</button>
                <button class="icon-btn" onclick="window.openCraftModal()" title="–ö—Ä–∞—Ñ—Ç">‚öíÔ∏è</button>
                
                <button id="btnShowTrades" class="secondary hidden" onclick="window.openIncomingTrades()">–í–•–û–î–Ø–©–ò–ï üíõ</button>
                
                <button id="btnSpyAction" class="icon-btn hidden" onclick="window.openSpyModal()" title="–®–ø–∏–æ–Ω–∞–∂">üïµÔ∏è‚Äç‚ôÇÔ∏è</button>
                <button id="btnScavenge" class="icon-btn hidden" onclick="window.handleScavengeInteraction('dummy_snow_pile_id')" title="–ò—Å–∫–∞—Ç—å –≤ —Å–Ω–µ–≥—É">üß§</button>
                <button id="btnGuardianWarm" class="icon-btn hidden" onclick="window.guardianWarmUp()" title="–°–æ–≥—Ä–µ—Ç—å">üî•</button>
            </div>
        </header>

        <main class="game-main">
            
            <aside class="inventory-panel card">
                <h2>üéí –†—é–∫–∑–∞–∫</h2>
                <ul id="inventoryList" class="inventory-list">
                    <li class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤...</li>
                </ul>
            </aside>

            <div id="map-container" class="map-wrapper card">
                <div id="interactiveMap"></div>
                <button id="btnLocate" class="locate-btn" onclick="window.renderMarkers()">üìç –ì–¥–µ —è?</button>
                
                <div class="map-legend">
                    <div><span class="mark tent"></span> –ü–∞–ª–∞—Ç–∫–∞</div>
                    <div><span class="mark npc"></span> NPC</div>
                    <div><span class="mark snow"></span> –°—É–≥—Ä–æ–±</div> <div><span class="mark team"></span> –ò–≥—Ä–æ–∫–∏</div>
                    <div><span class="mark me"></span> –í—ã</div>
                </div>
            </div>

            <section class="bottom-panel">
                <div class="tasks-panel card">
                    <h2 class="tasks-header">
                        –ú–∏—Å—Å–∏–∏ üìú 
                        <span id="taskProgress">0%</span>
                    </h2>
                    <div class="tasks-container">
                        <table class="tasks-table">
                            <thead>
                                <tr>
                                    <th style="width: 30px;">‚úî</th>
                                    <th>–¶–µ–ª—å</th>
                                    <th style="width: 30px; text-align:center;">üéÅ</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTableBody">
                                <tr><td colspan="3" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="team-info-panel card">
                    <h2>–°–æ—Å—Ç–∞–≤ (<span id="myTeamMembersCount">0</span>)</h2>
                    <ul id="currentTeamMembersList" class="member-list">
                        <li class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
                    </ul>
                </div>
            </section>
        </main>
    </div>

    <div id="interactionModal" class="modal-backdrop hidden">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header-strip"></div>
            <div class="modal-top-row">
                <h3 class="modal-title" id="interactTitle">...</h3>
                <button class="modal-close" onclick="window.closeModal('interactionModal')">√ó</button>
            </div>
            
            <div id="interactIcon" style="font-size: 4rem; margin: 10px 0;">‚õ∫</div>
            
            <div id="interactDesc" class="interaction-desc-text">...</div>
            
            <div id="interactButtons" class="interaction-buttons"></div>
        </div>
    </div>

    <div id="finalLockModal" class="modal-backdrop hidden" style="z-index: 9999;">
        <div class="modal-content final-lock-content">
            <h2 class="final-title">–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –ò–≥—Ä—É—à–∫–∏</h2>
            
            <div id="finalItemsGrid" class="items-grid-container">
            </div>

            <p id="finalLockStatus" class="status-text">–°–æ–±–µ—Ä–∏—Ç–µ –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏!</p>

            <div class="modal-buttons">
                <button id="btnActivateFinal" class="start-button" disabled onclick="window.tryActivateFinal()">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</button>
                <button class="secondary" style="margin-top:10px;" onclick="document.getElementById('finalLockModal').classList.add('hidden')">–ó–ê–ö–†–´–¢–¨</button>
            </div>
        </div>
    </div>

    <div id="itemsGuideModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="modal-header-strip"></div>
            <div class="modal-top-row">
                <h3 class="modal-title">üìñ –ü–†–ï–î–ú–ï–¢–´</h3>
                <button class="modal-close" onclick="window.closeItemsGuide()">√ó</button>
            </div>
            <div class="tasks-container" style="max-height: 400px; overflow-y: auto;">
                <table class="tasks-table">
                    <tbody id="itemsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tradeModal" class="modal-backdrop hidden">
         <div class="modal-content">
               <div class="modal-header-strip"></div>
               <div class="modal-top-row">
                 <h3 class="modal-title">üíõ –ü–†–ï–î–õ–û–ñ–ò–¢–¨ –û–ë–ú–ï–ù</h3>
                 <button class="modal-close" onclick="window.closeModal('tradeModal')">√ó</button>
             </div>
             <label class="label-accent">1. –ö–æ–º—É:</label> 
             <select id="tradeTargetTeam" class="modal-input"></select>
             <label class="label-accent" style="color:var(--accent-green)">2. –û—Ç–¥–∞–µ–º:</label> 
             <select id="tradeOfferSelect" class="modal-input"></select>
             <label class="label-accent" style="color:var(--accent-red)">3. –ü—Ä–æ—Å–∏–º:</label> 
             <select id="tradeRequestSelect" class="modal-input"></select>
             <button class="start-button" onclick="window.sendTradeRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
    </div>  

    <div id="incomingTradesModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="modal-header-strip"></div>
            <div class="modal-top-row">
                <h3 class="modal-title">üì® –í–•–û–î–Ø–©–ò–ï</h3>
                <button class="modal-close" onclick="window.closeModal('incomingTradesModal')">√ó</button>
            </div>
            <div id="incomingTradesList"></div>
        </div>  
    </div>

    <div id="endGameModal" class="modal-backdrop hidden" style="z-index: 20000;">
        <div class="modal-content" style="text-align: center; border: 2px solid var(--accent-gold);">
            <h1 id="endTitle" style="font-size: 2rem; margin-bottom: 10px; text-transform: uppercase;"></h1>
            <p id="endMessage" style="font-size: 1.1rem; color: var(--text-main); margin-bottom: 20px; line-height: 1.5;"></p>
            <button id="btnCloseModal" class="start-button hidden" onclick="window.closeModal('endGameModal')">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
    </div>

    <div id="targetModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="modal-top-row">
                <h3 class="modal-title">‚ùÑÔ∏è –ó–ê–ú–û–†–û–ó–ò–¢–¨ –ö–û–ì–û?</h3>
                <button class="modal-close" onclick="window.closeModal('targetModal')">√ó</button>
            </div>
            <p class="muted" style="margin-bottom: 15px;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Ö –ø—Ä–æ–≥—Ä–µ—Å—Å:</p>
            <select id="targetSelect" class="modal-input" style="margin-bottom: 20px;"></select>
            <button id="btnConfirmFreeze" class="start-button" style="background: var(--accent-ice); color: #000;">
                –û–¢–ü–†–ê–í–ò–¢–¨ –•–û–õ–û–î
            </button>
        </div>
    </div>

    <div id="craftModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="modal-header-strip" style="background: linear-gradient(90deg, #d946ef, #8b5cf6);"></div>
            <div class="modal-top-row">
                <h3 class="modal-title" style="color: #d946ef;">‚öíÔ∏è –ú–ê–°–¢–ï–†–°–ö–ê–Ø</h3>
                <button class="modal-close" onclick="window.closeModal('craftModal')">√ó</button>
            </div>
            <div id="craftRecipesList" style="max-height: 60vh; overflow-y: auto; padding-right: 5px;"></div>
        </div>
    </div>

    <div id="quizModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="modal-header-strip" style="background: repeating-linear-gradient(90deg, var(--accent-gold), var(--accent-gold) 20px, #b8860b 20px, #b8860b 40px);"></div>
            <div class="modal-top-row">
                <h3 class="modal-title" id="quizModalTitle" style="color: var(--accent-gold);">üìú –ö–í–ò–ó</h3>
                <button class="modal-close" onclick="window.closeModal('quizModal')">√ó</button>
            </div>
            
            <div id="quizQuestionsContainer" style="max-height: 60vh; overflow-y: auto; padding-right: 5px;">
            </div>

            <p id="quizScoreDisplay" class="muted" style="margin-top: 15px; font-weight: bold;"></p>
            <p id="quizFinalMessage" class="muted" style="margin-top: 5px; font-weight: bold; font-size: 1.1rem; color: var(--accent-red);"></p>
            
            <button id="quizSubmitBtn" class="start-button hidden" style="margin-top: 20px;" onclick="window.handleBulkSubmit()">
                –ü–†–û–í–ï–†–ò–¢–¨ –û–¢–í–ï–¢–´
            </button>
        </div>
    </div>
    
    <div id="secretWordModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="modal-header-strip" style="background: linear-gradient(90deg, #f1fa8c, #bd93f9);"></div>
            <div class="modal-top-row">
                <h3 class="modal-title" id="swModalTitle">–ó–ê–î–ê–ù–ò–ï –° –§–û–¢–û/–í–ò–î–ï–û</h3>
                <button class="modal-close" onclick="window.closeModal('secretWordModal')">√ó</button>
            </div>
            
            <div id="swModalIcon" style="font-size: 4rem; margin: 10px 0; text-align: center;">üì∏</div>
            
            <div id="swModalDesc" class="interaction-desc-text"></div>
            
            <a id="swModalTelegramLink" href="#" target="_blank" class="start-button" style="margin-top: 15px; background: #0088CC; color: white;">
                –û–¢–ü–†–ê–í–ò–¢–¨ –í TELEGRAM –ì–†–£–ü–ü–£
            </a>

            <label class="label-accent" style="margin-top: 25px;">–í–≤–µ–¥–∏—Ç–µ –°–µ–∫—Ä–µ—Ç–Ω–æ–µ –°–ª–æ–≤–æ (–æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞):</label>
            <input type="text" id="secretWordInput" class="modal-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –∑–¥–µ—Å—å" style="text-align: center;">
            
            <p id="swModalStatus" class="muted" style="margin: 10px 0; font-weight: bold;"></p>
            
            <button id="swModalSubmitBtn" class="start-button" onclick="window.handleSecretWordSubmit()">
                –ü–û–î–¢–í–ï–†–î–ò–¢–¨
            </button>
        </div>
    </div>

    <div id="gameChallengeModal" class="modal-backdrop hidden" style="z-index: 10005;">
        <div class="modal-content">
            <div class="modal-header-strip" style="background: linear-gradient(90deg, #ff00cc, #333399);"></div>
            <div class="modal-top-row">
                <h3 class="modal-title" id="gameChallengeTitle">–ò–ì–†–ê</h3>
                <button class="modal-close" onclick="window.closeModal('gameChallengeModal')">√ó</button>
            </div>

            <div id="gameChallengeStep1">
                <p class="muted" style="margin-bottom: 15px;">
                    –ë—Ä–æ—Å—å—Ç–µ –≤—ã–∑–æ–≤ –ª—é–±–æ–π –∫–æ–º–∞–Ω–¥–µ! <br>
                    <span style="color: var(--accent-red);">–û–Ω–∏ –Ω–µ —Å–º–æ–≥—É—Ç –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è.</span>
                </p>
                <select id="gameTargetTeam" class="modal-input" style="margin-bottom: 20px;"></select>
                <button id="btnSendChallenge" class="start-button" onclick="window.startChallenge()">
                    ‚öîÔ∏è –ë–†–û–°–ò–¢–¨ –í–´–ó–û–í
                </button>
            </div>

            <div id="gameBoardArea" class="hidden">
                <p id="gameStatusText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</p>
                <div id="gameBoardContainer"></div>
            </div>
        </div>
    </div>

    <div id="freezeOverlay" class="modal-backdrop hidden" style="z-index: 10001; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px);">
        <div class="modal-content" style="text-align: center; border: 2px solid var(--accent-ice); max-width: 400px; padding: 40px;">
            <h1 style="color: var(--accent-ice); margin-bottom: 10px;">ü•∂ –ö–û–ú–ê–ù–î–ê –ó–ê–ú–û–†–û–ñ–ï–ù–ê ü•∂</h1>
            <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 25px;">–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –¥–≤–∏–≥–∞—Ç—å—Å—è –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ–º –æ–±—ä–µ–∫—Ç–æ–≤.</p>
            <p style="font-size: 1.2rem; font-weight: 700; color: var(--accent-gold);">–î–æ —Ä–∞–∑–º–æ—Ä–æ–∑–∫–∏ –æ—Å—Ç–∞–ª–æ—Å—å:</p>
            <div id="freezeCountdown" style="font-size: 3rem; font-weight: 900; color: var(--accent-ice); margin-top: 10px;">00:00</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script type="module" src="game.js"></script>
</body>
</html>